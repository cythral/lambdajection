<Project>
    <PropertyGroup>
        <LambdajectionGenerator_OutputPath>$(MSBuildThisFileDirectory)bin/</LambdajectionGenerator_OutputPath>
    </PropertyGroup>

    <Target Name="RestoreGeneratorDependencies" BeforeTargets="BeforeBuild">
        <ItemGroup>
            <LambdajectionGenerator_BuildProperties Include="RestorePackagesPath=$(RestorePackagesPath)" />
            <LambdajectionGenerator_BuildProperties Include="RunningGeneratorSpecificRestore=true" />
            <LambdajectionGenerator_BuildProperties Include="MSBuildProjectExtensionsPath=$(MSBuildThisFileDirectory)obj" />
            <LambdajectionGenerator_BuildProperties Include="OutputPath=$(LambdajectionGenerator_OutputPath)" />
            <LambdajectionGenerator_BuildProperties Include="CopyLocalLockFileAssemblies=true" />
            <LambdajectionGenerator_BuildProperties Include="GeneratePackageOnBuild=false" />
        </ItemGroup>

        <MSBuild
            Projects="$(MSBuildThisFileDirectory)Generator.csproj"
            Targets="Restore;Build"
            Properties="@(LambdajectionGenerator_BuildProperties)"
            Condition="!Exists($(LambdajectionGenerator_OutputPath))"
        />

        <ItemGroup>
            <LambdajectionGenerator_BuildAssemblies
                Include="$(LambdajectionGenerator_OutputPath)*.dll"
            />

            <LambdajectionGenerator_BuildAssemblies
                Remove="@(LambdajectionGenerator_BuildAssemblies)"
                Condition="%(FileName) == 'System.Diagnostics.EventLog' and $([MSBuild]::IsOSPlatform('Windows'))"
            />
        </ItemGroup>

        <PropertyGroup>
            <LambdajectionBuildTimeAssemblies>$(LambdajectionBuildTimeAssemblies),@(LambdajectionGenerator_BuildAssemblies, ',')</LambdajectionBuildTimeAssemblies>
        </PropertyGroup>
    </Target>
</Project>